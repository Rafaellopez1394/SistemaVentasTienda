@{
    ViewBag.Title = "Reportes de Nómina";
}

<!-- Chart.js para gráficas -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<style>
    .filter-card {
        background: #f8f9fa;
        border-left: 4px solid #0891b2;
        padding: 20px;
        margin-bottom: 20px;
    }
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 30px;
    }
    .stat-card {
        border-left: 4px solid #14b8a6;
        transition: transform 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
</style>

<div class="container-fluid">
    <!-- Header con botones de exportación -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-file-alt text-info"></i> Reportes de Nómina
                    </h2>
                    <p class="text-muted mb-0">Análisis y reportes del sistema de nómina con filtros avanzados</p>
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="exportarExcel()">
                        <i class="fas fa-file-excel"></i> Exportar Excel
                    </button>
                    <button class="btn btn-danger" onclick="exportarPDF()">
                        <i class="fas fa-file-pdf"></i> Exportar PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel de Filtros Avanzados -->
    <div class="filter-card">
        <h5 class="mb-3">
            <i class="fas fa-filter text-primary"></i> Filtros Avanzados
        </h5>
        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label><i class="fas fa-calendar"></i> Fecha Inicio</label>
                    <input type="date" id="txtFechaInicio" class="form-control" />
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label><i class="fas fa-calendar"></i> Fecha Fin</label>
                    <input type="date" id="txtFechaFin" class="form-control" />
                </div>
            </div>
            <div class="col-md-2">
                <div class="form-group">
                    <label><i class="fas fa-building"></i> Departamento</label>
                    <select id="cboDepartamento" class="form-control">
                        <option value="">Todos</option>
                        <option value="Ventas">Ventas</option>
                        <option value="Administración">Administración</option>
                        <option value="Contabilidad">Contabilidad</option>
                        <option value="Almacén">Almacén</option>
                        <option value="Sistemas">Sistemas</option>
                    </select>
                </div>
            </div>
            <div class="col-md-2">
                <div class="form-group">
                    <label><i class="fas fa-user-tie"></i> Puesto</label>
                    <select id="cboPuesto" class="form-control">
                        <option value="">Todos</option>
                        <option value="Gerente">Gerente</option>
                        <option value="Vendedor">Vendedor</option>
                        <option value="Cajero">Cajero</option>
                        <option value="Contador">Contador</option>
                        <option value="Almacenista">Almacenista</option>
                    </select>
                </div>
            </div>
            <div class="col-md-2">
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary btn-block" onclick="aplicarFiltros()">
                        <i class="fas fa-search"></i> Filtrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tarjetas de estadísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Total Percepciones</h6>
                            <h3 class="mb-0" id="totalPercepciones">$0.00</h3>
                        </div>
                        <div class="text-success">
                            <i class="fas fa-arrow-up fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Total Deducciones</h6>
                            <h3 class="mb-0" id="totalDeducciones">$0.00</h3>
                        </div>
                        <div class="text-danger">
                            <i class="fas fa-arrow-down fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Nómina Neta</h6>
                            <h3 class="mb-0" id="totalNeto">$0.00</h3>
                        </div>
                        <div class="text-primary">
                            <i class="fas fa-money-bill-wave fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Total Empleados</h6>
                            <h3 class="mb-0" id="totalEmpleados">0</h3>
                        </div>
                        <div class="text-info">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficas Comparativas -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line text-primary"></i> Evolución Mensual de Nómina
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="chartEvolucion"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie text-success"></i> Distribución por Departamento
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="chartDepartamentos"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de resultados -->
    <div class="card shadow-sm">
        <div class="card-header bg-white">
            <h5 class="mb-0">
                <i class="fas fa-table text-info"></i> Detalle de Nóminas
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="tbReportes" class="table table-striped table-hover" style="width:100%">
                    <thead class="thead-light">
                        <tr>
                            <th>Folio</th>
                            <th>Periodo</th>
                            <th>Departamento</th>
                            <th>Puesto</th>
                            <th>Empleado</th>
                            <th>Percepciones</th>
                            <th>Deducciones</th>
                            <th>Neto</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Los datos se cargarán dinámicamente desde el servidor -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Integración con Contabilidad -->
    <div class="card shadow-sm mt-4">
        <div class="card-header bg-white">
            <h5 class="mb-0">
                <i class="fas fa-link text-warning"></i> Integración con Contabilidad
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-muted">Pólizas Generadas del Periodo</h6>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Póliza de Nómina - Enero 2024
                            <span class="badge badge-success">Contabilizada</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Provisión de ISR - Enero 2024
                            <span class="badge badge-success">Contabilizada</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Provisión IMSS - Enero 2024
                            <span class="badge badge-warning">Pendiente</span>
                        </li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6 class="text-muted">Acciones Disponibles</h6>
                    <button class="btn btn-outline-primary btn-block mb-2" onclick="generarPoliza()">
                        <i class="fas fa-file-invoice"></i> Generar Póliza de Nómina
                    </button>
                    <button class="btn btn-outline-success btn-block mb-2" onclick="verPolizas()">
                        <i class="fas fa-list"></i> Ver Todas las Pólizas
                    </button>
                    <button class="btn btn-outline-info btn-block" onclick="exportarContabilidad()">
                        <i class="fas fa-download"></i> Exportar para Contabilidad
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        var chartEvolucion, chartDepartamentos;
        var tablaReportes;

        $(document).ready(function () {
            inicializarFechas();
            inicializarTabla();
            inicializarGraficas();
            cargarDatosIniciales();
        });

        function inicializarFechas() {
            // Establecer fechas del mes actual
            var hoy = new Date();
            var primerDia = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            var ultimoDia = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
            
            $('#txtFechaInicio').val(primerDia.toISOString().split('T')[0]);
            $('#txtFechaFin').val(ultimoDia.toISOString().split('T')[0]);
        }

        function inicializarTabla() {
            tablaReportes = $('#tbReportes').DataTable({
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
                },
                order: [[0, 'desc']],
                pageLength: 25,
                responsive: true,
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'excel',
                        text: '<i class="fas fa-file-excel"></i> Excel',
                        className: 'btn btn-success btn-sm',
                        title: 'Reporte de Nómina'
                    },
                    {
                        extend: 'pdf',
                        text: '<i class="fas fa-file-pdf"></i> PDF',
                        className: 'btn btn-danger btn-sm',
                        title: 'Reporte de Nómina',
                        orientation: 'landscape'
                    }
                ],
                columns: [
                    { data: 'Folio' },
                    { data: 'Periodo' },
                    { data: 'Departamento' },
                    { data: 'Puesto' },
                    { data: 'Empleado' },
                    { 
                        data: 'Percepciones',
                        render: function(data) {
                            return '$' + parseFloat(data).toLocaleString('es-MX', {minimumFractionDigits: 2});
                        },
                        className: 'text-success'
                    },
                    { 
                        data: 'Deducciones',
                        render: function(data) {
                            return '$' + parseFloat(data).toLocaleString('es-MX', {minimumFractionDigits: 2});
                        },
                        className: 'text-danger'
                    },
                    { 
                        data: 'Neto',
                        render: function(data) {
                            return '<strong>$' + parseFloat(data).toLocaleString('es-MX', {minimumFractionDigits: 2}) + '</strong>';
                        },
                        className: 'text-primary'
                    },
                    {
                        data: null,
                        orderable: false,
                        render: function(data, type, row) {
                            return '<button class="btn btn-sm btn-info" onclick="verDetalle(\'' + row.Folio + '\')"><i class="fas fa-eye"></i></button>';
                        }
                    }
                ]
            });
        }

        function inicializarGraficas() {
            // Gráfica de Evolución Mensual
            var ctxEvolucion = document.getElementById('chartEvolucion').getContext('2d');
            chartEvolucion = new Chart(ctxEvolucion, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Percepciones',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Deducciones',
                        data: [],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Neto',
                        data: [],
                        borderColor: '#0891b2',
                        backgroundColor: 'rgba(8, 145, 178, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('es-MX');
                                }
                            }
                        }
                    }
                }
            });

            // Gráfica de Departamentos
            var ctxDepartamentos = document.getElementById('chartDepartamentos').getContext('2d');
            chartDepartamentos = new Chart(ctxDepartamentos, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#0891b2',
                            '#14b8a6',
                            '#10b981',
                            '#f59e0b',
                            '#8b5cf6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function cargarDatosIniciales() {
            console.log('Iniciando carga de datos...');
            cargarEstadisticas();
            cargarDatosTabla();
            cargarEvolucionMensual();
            cargarDistribucionDepartamentos();
        }

        function cargarEstadisticas() {
            var fechaInicio = $('#txtFechaInicio').val();
            var fechaFin = $('#txtFechaFin').val();
            var departamento = $('#cboDepartamento').val();
            var puesto = $('#cboPuesto').val();

            var url = '@Url.Action("ObtenerEstadisticas", "Nomina")';
            console.log('Cargando estadísticas desde:', url);

            $.ajax({
                url: url,
                type: 'GET',
                data: { 
                    fechaInicio: fechaInicio,
                    fechaFin: fechaFin,
                    departamento: departamento,
                    puesto: puesto
                },
                success: function(response) {
                    console.log('Respuesta estadísticas:', response);
                    if (response.success) {
                        $('#totalPercepciones').text('$' + response.totalPercepciones.toLocaleString('es-MX', {minimumFractionDigits: 2}));
                        $('#totalDeducciones').text('$' + response.totalDeducciones.toLocaleString('es-MX', {minimumFractionDigits: 2}));
                        $('#totalNeto').text('$' + response.totalNeto.toLocaleString('es-MX', {minimumFractionDigits: 2}));
                        $('#totalEmpleados').text(response.totalEmpleados);
                        
                        if (response.totalEmpleados === 0) {
                            console.warn('No hay datos de nómina en el sistema');
                        }
                    } else {
                        console.error('Error en respuesta:', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error al cargar estadísticas:', error);
                    console.error('Status:', status);
                    console.error('Response:', xhr.responseText);
                }
            });
        }

        function cargarDatosTabla() {
            var fechaInicio = $('#txtFechaInicio').val();
            var fechaFin = $('#txtFechaFin').val();
            var departamento = $('#cboDepartamento').val();
            var puesto = $('#cboPuesto').val();

            $.ajax({
                url: '@Url.Action("ObtenerDatosReportes", "Nomina")',
                type: 'GET',
                data: { 
                    fechaInicio: fechaInicio,
                    fechaFin: fechaFin,
                    departamento: departamento,
                    puesto: puesto
                },
                success: function(response) {
                    console.log('Respuesta datos tabla:', response);
                    if (response.success) {
                        tablaReportes.clear();
                        if (response.data && response.data.length > 0) {
                            tablaReportes.rows.add(response.data);
                        } else {
                            console.warn('No hay registros de nómina para mostrar en la tabla');
                        }
                        tablaReportes.draw();
                    } else {
                        console.error('Error en respuesta:', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error al cargar datos de la tabla:', error);
                    console.error('Status:', status);
                    console.error('Response:', xhr.responseText);
                }
            });
        }

        function cargarEvolucionMensual() {
            $.ajax({
                url: '@Url.Action("ObtenerEvolucionMensual", "Nomina")',
                type: 'GET',
                success: function(response) {
                    console.log('Respuesta evolución mensual:', response);
                    if (response.success && response.data && response.data.length > 0) {
                        var labels = response.data.map(d => d.Periodo);
                        var percepciones = response.data.map(d => d.Percepciones);
                        var deducciones = response.data.map(d => d.Deducciones);
                        var neto = response.data.map(d => d.Neto);

                        chartEvolucion.data.labels = labels;
                        chartEvolucion.data.datasets[0].data = percepciones;
                        chartEvolucion.data.datasets[1].data = deducciones;
                        chartEvolucion.data.datasets[2].data = neto;
                        chartEvolucion.update();
                    } else {
                        console.warn('No hay datos para la gráfica de evolución');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error al cargar evolución mensual:', error);
                    console.error('Status:', status);
                    console.error('Response:', xhr.responseText);
                }
            });
        }

        function cargarDistribucionDepartamentos() {
            $.ajax({
                url: '@Url.Action("ObtenerDistribucionDepartamentos", "Nomina")',
                type: 'GET',
                success: function(response) {
                    if (response.success && response.data.length > 0) {
                        var labels = response.data.map(d => d.Departamento);
                        var totales = response.data.map(d => d.Total);

                        chartDepartamentos.data.labels = labels;
                        chartDepartamentos.data.datasets[0].data = totales;
                        chartDepartamentos.update();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error al cargar distribución por departamentos:', error);
                    console.error('Status:', status);
                    console.error('Response:', xhr.responseText);
                }
            });
        }

        function aplicarFiltros() {
            var fechaInicio = $('#txtFechaInicio').val();
            var fechaFin = $('#txtFechaFin').val();
            var departamento = $('#cboDepartamento').val();
            var puesto = $('#cboPuesto').val();

            if (!fechaInicio || !fechaFin) {
                Swal.fire({
                    title: "Fechas requeridas",
                    text: "Por favor selecciona un rango de fechas",
                    icon: "warning"
                });
                return;
            }

            // Recargar todos los datos con filtros
            cargarEstadisticas();
            cargarDatosTabla();
            
            Swal.fire({
                title: "Filtros aplicados",
                text: "Datos actualizados correctamente",
                icon: "success",
                timer: 1500,
                showConfirmButton: false
            });
        }

        function exportarExcel() {
            // Usar el botón de DataTables para exportar
            $('.buttons-excel').click();
        }

        function exportarPDF() {
            // Usar el botón de DataTables para exportar
            $('.buttons-pdf').click();
        }

        function verDetalle(folio) {
            window.location.href = '@Url.Action("Index", "Nomina")';
        }

        function generarPoliza() {
            // Obtener fechas del filtro actual
            var fechaInicio = $('#txtFechaInicio').val();
            var fechaFin = $('#txtFechaFin').val();
            
            if (!fechaInicio || !fechaFin) {
                Swal.fire("Error", "Por favor seleccione un periodo válido", "error");
                return;
            }
            
            Swal.fire({
                title: "Generar Póliza",
                html: "¿Desea generar la póliza contable de nómina del periodo?<br><strong>" + 
                      fechaInicio + " al " + fechaFin + "</strong>",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Generar",
                cancelButtonText: "Cancelar",
                confirmButtonColor: "#0891b2",
                cancelButtonColor: "#94a3b8"
            }).then((result) => {
                if (result.isConfirmed) {
                    // Mostrar loading
                    Swal.fire({
                        title: 'Procesando...',
                        text: 'Generando póliza contable',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    // Llamar al backend para generar la póliza
                    $.ajax({
                        url: '@Url.Action("GenerarPolizaNomina", "Poliza")',
                        type: 'POST',
                        data: {
                            fechaInicio: fechaInicio,
                            fechaFin: fechaFin
                        },
                        success: function (response) {
                            Swal.close();
                            if (response.resultado) {
                                Swal.fire({
                                    title: "¡Póliza generada!",
                                    html: "La póliza contable se ha generado correctamente<br><strong>Póliza ID: " + response.polizaId + "</strong>",
                                    icon: "success",
                                    confirmButtonText: "Ver Póliza",
                                    showCancelButton: true,
                                    cancelButtonText: "Cerrar",
                                    confirmButtonColor: "#0891b2"
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        window.location.href = '@Url.Action("Consultar", "Poliza")';
                                    }
                                });
                            } else {
                                Swal.fire("Error", response.mensaje || "No se pudo generar la póliza", "error");
                            }
                        },
                        error: function (xhr, status, error) {
                            Swal.close();
                            console.error("Error al generar póliza:", error);
                            Swal.fire("Error", "No se pudo conectar con el servidor: " + error, "error");
                        }
                    });
                }
            });
        }

        function verPolizas() {
            window.location.href = '@Url.Action("Index", "Poliza")';
        }

        function exportarContabilidad() {
            Swal.fire({
                title: "Exportar para Contabilidad",
                text: "Generando archivo XML para importación en sistema contable...",
                icon: "info",
                timer: 2000,
                showConfirmButton: false
            });
            // Aquí se haría la descarga del archivo XML
        }
    </script>
}
