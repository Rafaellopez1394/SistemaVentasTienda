@{
    ViewBag.Title = "Control de Lotes";
}

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.6.0/css/bootstrap.min.css" />
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.6.0/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

<div class="container mt-4">

    <h3 class="text-primary font-weight-bold">Administración de Lotes</h3>
    <hr />

    <!-- Tabla -->
    <table id="tablaLotes" class="table table-bordered table-striped">
        <thead class="thead-dark">
            <tr>
                <th>Lote</th>
                <th>Producto</th>
                <th>Entrada</th>
                <th>Caducidad</th>
                <th>Total</th>
                <th>Disponible</th>
                <th>Precio Venta</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- MODAL EDITAR LOTE -->
<div class="modal fade" id="modalEditar" tabindex="-1">
    <div class="modal-dialog">
        <form id="formEditar" class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Editar Lote</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <div class="modal-body">

                <input type="hidden" id="edit_LoteID" />

                <div class="form-group">
                    <label>Fecha Caducidad</label>
                    <input type="date" id="edit_Caducidad" class="form-control" />
                </div>

                <div class="form-group">
                    <label>Precio Compra</label>
                    <input type="number" step="0.01" id="edit_PrecioCompra" class="form-control" />
                </div>

                <div class="form-group">
                    <label>Precio Venta</label>
                    <input type="number" step="0.01" id="edit_PrecioVenta" class="form-control" />
                </div>

            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </div>
        </form>
    </div>
</div>

<!-- MODAL AJUSTAR CANTIDAD -->
<div class="modal fade" id="modalAjustar" tabindex="-1">
    <div class="modal-dialog">
        <form id="formAjustar" class="modal-content">

            <div class="modal-header bg-warning">
                <h5 class="modal-title">Ajustar Cantidad del Lote</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <div class="modal-body">

                <input type="hidden" id="ajuste_LoteID" />

                <div class="form-group">
                    <label>Motivo</label>
                    <select id="ajuste_Motivo" class="form-control">
                        <option value="MERMA">Merma</option>
                        <option value="SALIDA">Salida</option>
                        <option value="AJUSTE">Ajuste Manual</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Cantidad</label>
                    <input type="number" id="ajuste_Cantidad" class="form-control" placeholder="Ingrese cantidad (ej: -5 ó 10)" />
                </div>

            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-warning">Aplicar Ajuste</button>
            </div>
        </form>
    </div>
</div>

<script>
// ================================
//   FORMATO FECHAS SQL → LEGIBLE
// ================================
function formatFecha(f) {
    if (!f) return "";
    return moment(f).format("DD/MM/YYYY HH:mm");
}

// ================================
//      CARGAR LISTA DE LOTES
// ================================
function cargarLotes() {
    $.ajax({
        url: "/Lote/GetLotes",
        type: "GET",
        success: function (data) {
            let rows = "";

            data.forEach(l => {
                rows += `
                    <tr>
                        <td>${l.LoteID}</td>
                        <td>${l.NombreProducto}</td>
                        <td>${formatFecha(l.FechaEntrada)}</td>
                        <td>${formatFecha(l.FechaCaducidad)}</td>
                        <td>${l.CantidadTotal}</td>
                        <td>${l.CantidadDisponible}</td>
                        <td>$${l.PrecioVenta.toFixed(2)}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="abrirEditar(${l.LoteID})">Editar</button>
                            <button class="btn btn-sm btn-warning" onclick="abrirAjuste(${l.LoteID})">Ajustar</button>
                        </td>
                    </tr>
                `;
            });

            $("#tablaLotes tbody").html(rows);
        }
    });
}

cargarLotes();

// ================================
//      ABRIR MODAL EDITAR
// ================================
function abrirEditar(id) {
    $.get("/Lote/GetLote", { id: id }, function (l) {
        $("#edit_LoteID").val(l.LoteID);
        $("#edit_Caducidad").val(l.FechaCaducidad ? l.FechaCaducidad.substring(0, 10) : "");
        $("#edit_PrecioCompra").val(l.PrecioCompra);
        $("#edit_PrecioVenta").val(l.PrecioVenta);
        $("#modalEditar").modal("show");
    });
}

// ================================
//     SUBMIT EDITAR LOTE
// ================================
$("#formEditar").submit(function (e) {
    e.preventDefault();

    $.ajax({
        url: "/Lote/Actualizar",
        type: "POST",
        data: {
            LoteID: $("#edit_LoteID").val(),
            FechaCaducidad: $("#edit_Caducidad").val(),
            PrecioCompra: $("#edit_PrecioCompra").val(),
            PrecioVenta: $("#edit_PrecioVenta").val()
        },
        success: function (r) {
            if (r.ok) {
                $("#modalEditar").modal("hide");
                cargarLotes();
            } else {
                alert("Error al actualizar el lote.");
            }
        }
    });
});

// ================================
//     ABRIR MODAL AJUSTAR
// ================================
function abrirAjuste(id) {
    $("#ajuste_LoteID").val(id);
    $("#ajuste_Cantidad").val("");
    $("#modalAjustar").modal("show");
}

// ================================
//     SUBMIT AJUSTE
// ================================
$("#formAjustar").submit(function (e) {
    e.preventDefault();

    $.ajax({
        url: "/Lote/Ajustar",
        type: "POST",
        data: {
            loteID: $("#ajuste_LoteID").val(),
            cantidad: $("#ajuste_Cantidad").val(),
            motivo: $("#ajuste_Motivo").val()
        },
        success: function (r) {
            if (r.ok) {
                $("#modalAjustar").modal("hide");
                cargarLotes();
            } else {
                alert("Error al ajustar el lote.");
            }
        }
    });
});
</script>
