@{
    ViewBag.Title = "Dashboard";
}

<!-- BIENVENIDA -->
<div class="row mb-4">
    <div class="col-12">
        <div class="dashboard-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-2">¡Bienvenido de nuevo, @ViewBag.NombreUsuario!</h1>
                    <p class="text-muted mb-0">
                        <i class="fas fa-user-shield"></i> <strong>Rol:</strong> @ViewBag.RolUsuario 
                        <span class="mx-2">|</span>
                        <i class="fas fa-calendar-alt"></i> @DateTime.Now.ToString("dddd, dd MMMM yyyy", new System.Globalization.CultureInfo("es-MX"))
                        <span class="mx-2">|</span>
                        <i class="fas fa-clock"></i> <span id="currentTime"></span>
                    </p>
                </div>
                <div class="d-none d-md-block">
                    <i class="fas fa-store fa-4x text-primary" style="opacity: 0.2;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- KPI CARDS -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card success">
            <div class="stat-icon">
                <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="stat-details">
                <h3 id="ventasHoy">$0.00</h3>
                <p>Ventas de Hoy</p>
                <small class="text-success"><i class="fas fa-arrow-up"></i> +12.5% vs ayer</small>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-shopping-cart"></i>
            </div>
            <div class="stat-details">
                <h3 id="transaccionesHoy">0</h3>
                <p>Transacciones Hoy</p>
                <small class="text-muted">Tickets procesados</small>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card warning">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-details">
                <h3 id="clientesActivos">0</h3>
                <p>Clientes Activos</p>
                <small class="text-warning"><i class="fas fa-exclamation-circle"></i> 5 con crédito vencido</small>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card danger">
            <div class="stat-icon">
                <i class="fas fa-boxes"></i>
            </div>
            <div class="stat-details">
                <h3 id="productosStock">0</h3>
                <p>Productos en Stock</p>
                <small class="text-danger"><i class="fas fa-exclamation-triangle"></i> 8 con stock bajo</small>
            </div>
        </div>
    </div>
</div>

<!-- GRÁFICOS Y WIDGETS -->
<div class="row mb-4">
    <div class="col-lg-8 mb-3">
        <div class="dashboard-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0"><i class="fas fa-chart-line"></i> Ventas de la Semana</h4>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary active">Semana</button>
                    <button type="button" class="btn btn-outline-primary">Mes</button>
                    <button type="button" class="btn btn-outline-primary">Año</button>
                </div>
            </div>
            <canvas id="chartVentas" height="80"></canvas>
        </div>
    </div>

    <div class="col-lg-4 mb-3">
        <div class="dashboard-card">
            <h4 class="mb-3"><i class="fas fa-trophy"></i> Productos Más Vendidos</h4>
            <div id="topProductos">
                <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                    <div class="d-flex align-items-center">
                        <div class="badge badge-success mr-2">1</div>
                        <div>
                            <strong>Coca-Cola 600ml</strong>
                            <br><small class="text-muted">125 unidades</small>
                        </div>
                    </div>
                    <span class="badge badge-primary">$1,875</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                    <div class="d-flex align-items-center">
                        <div class="badge badge-secondary mr-2">2</div>
                        <div>
                            <strong>Pan Blanco</strong>
                            <br><small class="text-muted">98 unidades</small>
                        </div>
                    </div>
                    <span class="badge badge-primary">$1,470</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                    <div class="d-flex align-items-center">
                        <div class="badge badge-warning mr-2">3</div>
                        <div>
                            <strong>Leche 1L</strong>
                            <br><small class="text-muted">87 unidades</small>
                        </div>
                    </div>
                    <span class="badge badge-primary">$1,305</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="d-flex align-items-center">
                        <div class="badge badge-secondary mr-2">4</div>
                        <div>
                            <strong>Huevos 12 pzas</strong>
                            <br><small class="text-muted">76 unidades</small>
                        </div>
                    </div>
                    <span class="badge badge-primary">$1,140</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ACCIONES RÁPIDAS -->
<div class="row mb-4">
    <div class="col-12">
        <div class="dashboard-card">
            <h4 class="mb-3"><i class="fas fa-bolt"></i> Acciones Rápidas</h4>
            <div class="row">
                <div class="col-lg-2 col-md-4 col-6 mb-3">
                    <a href="@Url.Action("Index", "VentaPOS")" class="btn btn-lg btn-success btn-block">
                        <i class="fas fa-cash-register fa-2x mb-2"></i>
                        <br><span>Nueva Venta</span>
                    </a>
                </div>
                <div class="col-lg-2 col-md-4 col-6 mb-3">
                    <a href="@Url.Action("Index", "Cliente")" class="btn btn-lg btn-primary btn-block">
                        <i class="fas fa-user-plus fa-2x mb-2"></i>
                        <br><span>Nuevo Cliente</span>
                    </a>
                </div>
                <div class="col-lg-2 col-md-4 col-6 mb-3">
                    <a href="@Url.Action("Index", "Producto")" class="btn btn-lg btn-info btn-block">
                        <i class="fas fa-box fa-2x mb-2"></i>
                        <br><span>Productos</span>
                    </a>
                </div>
                <div class="col-lg-2 col-md-4 col-6 mb-3">
                    <a href="@Url.Action("Consultar", "Venta")" class="btn btn-lg btn-warning btn-block">
                        <i class="fas fa-file-invoice fa-2x mb-2"></i>
                        <br><span>Ver Ventas</span>
                    </a>
                </div>
                <div class="col-lg-2 col-md-4 col-6 mb-3">
                    <a href="@Url.Action("Index", "Reporte")" class="btn btn-lg btn-secondary btn-block">
                        <i class="fas fa-chart-bar fa-2x mb-2"></i>
                        <br><span>Reportes</span>
                    </a>
                </div>
                <div class="col-lg-2 col-md-4 col-6 mb-3">
                    <a href="@Url.Action("Index", "Configuracion")" class="btn btn-lg btn-dark btn-block">
                        <i class="fas fa-cog fa-2x mb-2"></i>
                        <br><span>Configuración</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ALERTAS Y NOTIFICACIONES -->
<div class="row">
    <div class="col-lg-6 mb-3">
        <div class="dashboard-card">
            <h4 class="mb-3"><i class="fas fa-exclamation-triangle text-warning"></i> Alertas de Inventario</h4>
            <div class="alert alert-warning mb-2">
                <strong>Stock Bajo:</strong> 8 productos necesitan reabastecimiento
            </div>
            <div class="alert alert-danger mb-2">
                <strong>Sin Stock:</strong> 3 productos agotados
            </div>
            <div class="alert alert-info mb-0">
                <strong>Próximos a Vencer:</strong> 5 productos vencen en 7 días
            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-3">
        <div class="dashboard-card">
            <h4 class="mb-3"><i class="fas fa-bell text-info"></i> Notificaciones Recientes</h4>
            <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                <div>
                    <i class="fas fa-shopping-cart text-success"></i>
                    <strong class="ml-2">Nueva venta registrada</strong>
                    <br><small class="text-muted ml-4">Ticket #1234 - $450.00</small>
                </div>
                <small class="text-muted">Hace 5 min</small>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                <div>
                    <i class="fas fa-user-plus text-primary"></i>
                    <strong class="ml-2">Cliente registrado</strong>
                    <br><small class="text-muted ml-4">Juan Pérez López</small>
                </div>
                <small class="text-muted">Hace 15 min</small>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <i class="fas fa-credit-card text-warning"></i>
                    <strong class="ml-2">Pago de crédito</strong>
                    <br><small class="text-muted ml-4">$300.00 - María García</small>
                </div>
                <small class="text-muted">Hace 1 hora</small>
            </div>
        </div>
    </div>
</div>

@section scripts{
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <script>
        $(document).ready(function() {
            // Reloj en tiempo real
            function updateTime() {
                const now = new Date();
                const time = now.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                $('#currentTime').text(time);
            }
            updateTime();
            setInterval(updateTime, 1000);

            // Gráfico de ventas
            const ctx = document.getElementById('chartVentas').getContext('2d');
            const chartVentas = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'],
                    datasets: [{
                        label: 'Ventas ($)',
                        data: [12500, 19800, 15300, 22100, 18900, 28400, 31200],
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#3498db'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // Cargar datos reales del dashboard
            $.get('@Url.Action("ObtenerDashboardData", "Home")', function(response) {
                console.log('Datos del dashboard recibidos:', response);
                
                if (response.success) {
                    // Actualizar KPIs
                    $('#ventasHoy').text('$' + response.ventasHoy.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
                    $('#transaccionesHoy').text(response.transaccionesHoy);
                    $('#clientesActivos').text(response.clientesActivos);
                    $('#productosStock').text(response.productosStock);
                    
                    // Actualizar alerta de stock bajo
                    if (response.productosStockBajo > 0) {
                        $('#productosStock').closest('.stat-card').find('small').html(
                            '<i class="fas fa-exclamation-triangle"></i> ' + response.productosStockBajo + ' con stock bajo'
                        );
                    } else {
                        $('#productosStock').closest('.stat-card').find('small').html(
                            '<i class="fas fa-check-circle"></i> Stock saludable'
                        );
                    }

                    // Actualizar gráfico con datos reales
                    if (response.ventasSemana && response.ventasSemana.length > 0) {
                        console.log('Actualizando gráfico con:', response.ventasSemana);
                        chartVentas.data.labels = response.diasSemana;
                        chartVentas.data.datasets[0].data = response.ventasSemana;
                        chartVentas.update();
                    } else {
                        console.warn('No hay datos de ventas para la semana');
                    }

                    // Actualizar indicadores visuales
                    $('.stat-card').addClass('loaded');
                } else {
                    console.error('Error en la respuesta:', response.mensaje);
                    toastr.error('Error al cargar datos: ' + (response.mensaje || 'Desconocido'));
                }
            }).fail(function(xhr, status, error) {
                console.error('Error AJAX al cargar datos del dashboard:', error);
                console.error('Status:', status);
                console.error('Response:', xhr.responseText);
                
                // Mostrar valores por defecto
                $('#ventasHoy').text('$0.00');
                $('#transaccionesHoy').text('0');
                $('#clientesActivos').text('0');
                $('#productosStock').text('0');
            });
        });
    </script>
    
    <script src="@Url.Content("~/Scripts/Views/Home_Index.js")" type="text/javascript"></script>
}
