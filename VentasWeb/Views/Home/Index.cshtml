@{
    ViewBag.Title = "Dashboard";
}

<!-- BIENVENIDA -->
<div class="row mb-4">
    <div class="col-12">
        <div class="dashboard-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-2">¡Bienvenido de nuevo, @ViewBag.NombreUsuario!</h1>
                    <p class="text-muted mb-0">
                        <i class="fas fa-user-shield"></i> <strong>Rol:</strong> @ViewBag.RolUsuario 
                        <span class="mx-2">|</span>
                        <i class="fas fa-calendar-alt"></i> @DateTime.Now.ToString("dddd, dd MMMM yyyy", new System.Globalization.CultureInfo("es-MX"))
                        <span class="mx-2">|</span>
                        <i class="fas fa-clock"></i> <span id="currentTime"></span>
                    </p>
                </div>
                <div class="d-none d-md-block">
                    <i class="fas fa-store fa-4x text-primary" style="opacity: 0.2;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- KPI CARDS -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card success">
            <div class="stat-icon">
                <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="stat-details">
                <h3 id="ventasHoy">$0.00</h3>
                <p>Ventas de Hoy</p>
                <small class="text-muted" id="ventasHoyInfo">Cargando...</small>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-shopping-cart"></i>
            </div>
            <div class="stat-details">
                <h3 id="transaccionesHoy">0</h3>
                <p>Transacciones Hoy</p>
                <small class="text-muted">Tickets procesados</small>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card warning">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-details">
                <h3 id="clientesActivos">0</h3>
                <p>Clientes Activos</p>
                <small class="text-muted" id="clientesInfo">Total registrados</small>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card danger">
            <div class="stat-icon">
                <i class="fas fa-boxes"></i>
            </div>
            <div class="stat-details">
                <h3 id="productosStock">0</h3>
                <p>Productos en Stock</p>
                <small class="text-muted" id="productosInfo">Total registrados</small>
            </div>
        </div>
    </div>
</div>

<!-- GRÁFICOS Y WIDGETS -->
<div class="row mb-4">
    <div class="col-lg-8 mb-3">
        <div class="dashboard-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0"><i class="fas fa-chart-line"></i> Ventas de la Semana</h4>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary active">Semana</button>
                    <button type="button" class="btn btn-outline-primary">Mes</button>
                    <button type="button" class="btn btn-outline-primary">Año</button>
                </div>
            </div>
            <canvas id="chartVentas" height="80"></canvas>
        </div>
    </div>

    <div class="col-lg-4 mb-3">
        <div class="dashboard-card">
            <h4 class="mb-3"><i class="fas fa-trophy"></i> Productos Más Vendidos</h4>
            <div id="topProductos">
                <p class="text-center text-muted py-4">
                    <i class="fas fa-chart-line fa-3x mb-2"></i><br>
                    Cargando productos más vendidos...
                </p>
            </div>
        </div>
    </div>
</div>

<!-- ACCIONES RÁPIDAS -->
<div class="row mb-4">
    <div class="col-12">
        <div class="dashboard-card">
            <h4 class="mb-3"><i class="fas fa-bolt"></i> Acciones Rápidas</h4>
            <div class="row">
                <div class="col-lg-2 col-md-4 col-6 mb-3">
                    <a href="@Url.Action("Index", "VentaPOS")" class="btn btn-lg btn-success btn-block">
                        <i class="fas fa-cash-register fa-2x mb-2"></i>
                        <br><span>Nueva Venta</span>
                    </a>
                </div>
                <div class="col-lg-2 col-md-4 col-6 mb-3">
                    <a href="@Url.Action("Index", "Cliente")" class="btn btn-lg btn-primary btn-block">
                        <i class="fas fa-user-plus fa-2x mb-2"></i>
                        <br><span>Nuevo Cliente</span>
                    </a>
                </div>
                <div class="col-lg-2 col-md-4 col-6 mb-3">
                    <a href="@Url.Action("Index", "Producto")" class="btn btn-lg btn-info btn-block">
                        <i class="fas fa-box fa-2x mb-2"></i>
                        <br><span>Productos</span>
                    </a>
                </div>
                <div class="col-lg-2 col-md-4 col-6 mb-3">
                    <a href="@Url.Action("Consultar", "Venta")" class="btn btn-lg btn-warning btn-block">
                        <i class="fas fa-file-invoice fa-2x mb-2"></i>
                        <br><span>Ver Ventas</span>
                    </a>
                </div>
                <div class="col-lg-2 col-md-4 col-6 mb-3">
                    <a href="@Url.Action("Index", "Reporte")" class="btn btn-lg btn-secondary btn-block">
                        <i class="fas fa-chart-bar fa-2x mb-2"></i>
                        <br><span>Reportes</span>
                    </a>
                </div>
                <div class="col-lg-2 col-md-4 col-6 mb-3">
                    <a href="@Url.Action("Index", "Configuracion")" class="btn btn-lg btn-dark btn-block">
                        <i class="fas fa-cog fa-2x mb-2"></i>
                        <br><span>Configuración</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ALERTAS Y NOTIFICACIONES -->
<div class="row">
    <div class="col-lg-6 mb-3">
        <div class="dashboard-card">
            <h4 class="mb-3"><i class="fas fa-exclamation-triangle text-warning"></i> Alertas de Inventario</h4>
            <div id="alertasInventario">
                <p class="text-center text-muted py-3">
                    <i class="fas fa-box-open fa-2x mb-2"></i><br>
                    Cargando alertas...
                </p>
            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-3">
        <div class="dashboard-card">
            <h4 class="mb-3"><i class="fas fa-bell text-info"></i> Ventas Recientes</h4>
            <div id="ventasRecientes">
                <p class="text-center text-muted py-3">
                    <i class="fas fa-shopping-cart fa-2x mb-2"></i><br>
                    Cargando ventas recientes...
                </p>
            </div>
        </div>
    </div>
</div>

@section scripts{
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <script>
        $(document).ready(function() {
            // Reloj en tiempo real
            function updateTime() {
                const now = new Date();
                const time = now.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                $('#currentTime').text(time);
            }
            updateTime();
            setInterval(updateTime, 1000);

            // Gráfico de ventas (se inicializa vacío)
            const ctx = document.getElementById('chartVentas').getContext('2d');
            const chartVentas = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Ventas ($)',
                        data: [],
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#3498db'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // Cargar datos reales del dashboard
            $.get('@Url.Action("ObtenerDashboardData", "Home")', function(response) {
                console.log('Datos del dashboard recibidos:', response);
                
                if (response.success) {
                    // Actualizar KPIs
                    $('#ventasHoy').text('$' + response.ventasHoy.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
                    $('#transaccionesHoy').text(response.transaccionesHoy);
                    $('#clientesActivos').text(response.clientesActivos);
                    $('#productosStock').text(response.productosStock);
                    
                    // Actualizar alerta de stock bajo
                    if (response.productosStockBajo > 0) {
                        $('#productosStock').closest('.stat-card').find('small').html(
                            '<i class="fas fa-exclamation-triangle"></i> ' + response.productosStockBajo + ' con stock bajo'
                        );
                    } else {
                        $('#productosStock').closest('.stat-card').find('small').html(
                            '<i class="fas fa-check-circle"></i> Stock saludable'
                        );
                    }

                    // Actualizar gráfico con datos reales
                    if (response.ventasSemana && response.ventasSemana.length > 0) {
                        console.log('Actualizando gráfico con:', response.ventasSemana);
                        chartVentas.data.labels = response.diasSemana;
                        chartVentas.data.datasets[0].data = response.ventasSemana;
                        chartVentas.update();
                    } else {
                        console.warn('No hay datos de ventas para la semana');
                    }

                    // Actualizar productos más vendidos
                    if (response.topProductos && response.topProductos.length > 0) {
                        var html = '';
                        response.topProductos.forEach(function(producto, index) {
                            var badgeClass = index === 0 ? 'badge-success' : (index === 1 ? 'badge-secondary' : 'badge-warning');
                            var borderClass = index < response.topProductos.length - 1 ? 'border-bottom' : '';
                            html += '<div class="d-flex justify-content-between align-items-center mb-3 pb-2 ' + borderClass + '">';
                            html += '  <div class="d-flex align-items-center">';
                            html += '    <div class="badge ' + badgeClass + ' mr-2">' + (index + 1) + '</div>';
                            html += '    <div>';
                            html += '      <strong>' + producto.Nombre + '</strong>';
                            html += '      <br><small class="text-muted">' + producto.CantidadVendida + ' unidades</small>';
                            html += '    </div>';
                            html += '  </div>';
                            html += '  <span class="badge badge-primary">$' + parseFloat(producto.TotalVendido).toLocaleString('es-MX', {minimumFractionDigits: 2}) + '</span>';
                            html += '</div>';
                        });
                        $('#topProductos').html(html);
                    } else {
                        $('#topProductos').html('<p class="text-center text-muted py-4"><i class="fas fa-inbox"></i><br>No hay datos de productos vendidos hoy</p>');
                    }

                    // Actualizar ventas recientes
                    if (response.ventasRecientes && response.ventasRecientes.length > 0) {
                        var html = '';
                        response.ventasRecientes.forEach(function(venta, index) {
                            var borderClass = index < response.ventasRecientes.length - 1 ? 'border-bottom' : '';
                            html += '<div class="d-flex justify-content-between align-items-center mb-3 pb-2 ' + borderClass + '">';
                            html += '  <div>';
                            html += '    <i class="fas fa-shopping-cart text-success"></i>';
                            html += '    <strong class="ml-2">Ticket #' + venta.NumeroVenta + '</strong>';
                            html += '    <br><small class="text-muted ml-4">$' + parseFloat(venta.Total).toLocaleString('es-MX', {minimumFractionDigits: 2}) + '</small>';
                            html += '  </div>';
                            html += '  <small class="text-muted">' + venta.FechaCreacion + '</small>';
                            html += '</div>';
                        });
                        $('#ventasRecientes').html(html);
                    } else {
                        $('#ventasRecientes').html('<p class="text-center text-muted py-4"><i class="fas fa-inbox"></i><br>No hay ventas registradas hoy</p>');
                    }

                    // Actualizar alertas de inventario
                    var alertasHtml = '';
                    if (response.productosStockBajo > 0) {
                        alertasHtml += '<div class="alert alert-warning mb-2">';
                        alertasHtml += '  <strong>Stock Bajo:</strong> ' + response.productosStockBajo + ' productos necesitan reabastecimiento';
                        alertasHtml += '</div>';
                    }
                    
                    if (alertasHtml === '') {
                        alertasHtml = '<div class="alert alert-success mb-0">';
                        alertasHtml += '  <i class="fas fa-check-circle"></i> <strong>Sin alertas</strong> - Todo el inventario está en niveles óptimos';
                        alertasHtml += '</div>';
                    }
                    $('#alertasInventario').html(alertasHtml);

                    // Actualizar indicadores visuales
                    $('.stat-card').addClass('loaded');
                } else {
                    console.error('Error en la respuesta:', response.mensaje);
                    toastr.error('Error al cargar datos: ' + (response.mensaje || 'Desconocido'));
                }
            }).fail(function(xhr, status, error) {
                console.error('Error AJAX al cargar datos del dashboard:', error);
                console.error('Status:', status);
                console.error('Response:', xhr.responseText);
                
                // Mostrar valores por defecto
                $('#ventasHoy').text('$0.00');
                $('#transaccionesHoy').text('0');
                $('#clientesActivos').text('0');
                $('#productosStock').text('0');
                $('#topProductos').html('<p class="text-center text-muted py-4"><i class="fas fa-exclamation-circle"></i><br>Error al cargar datos</p>');
                $('#ventasRecientes').html('<p class="text-center text-muted py-4"><i class="fas fa-exclamation-circle"></i><br>Error al cargar datos</p>');
                $('#alertasInventario').html('<div class="alert alert-danger">Error al cargar alertas de inventario</div>');
            });
        });
    </script>
    
    <script src="@Url.Content("~/Scripts/Views/Home_Index.js")" type="text/javascript"></script>
}
