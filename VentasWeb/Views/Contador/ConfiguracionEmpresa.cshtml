@{
    ViewBag.Title = "Configuración de Empresa";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <h2><i class="fas fa-building"></i> Configuración de Empresa</h2>
            <p class="text-muted">Datos fiscales y de contacto de la empresa</p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Datos Fiscales</h5>
                </div>
                <div class="card-body">
                    <form id="formEmpresa">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>RFC <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="txtRFC" maxlength="13" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Régimen Fiscal <span class="text-danger">*</span></label>
                                    <select class="form-control" id="cboRegimenFiscal" required>
                                        <option value="">-- Seleccione --</option>
                                        <option value="601">601 - General de Ley Personas Morales</option>
                                        <option value="603">603 - Personas Morales con Fines no Lucrativos</option>
                                        <option value="605">605 - Sueldos y Salarios</option>
                                        <option value="606">606 - Arrendamiento</option>
                                        <option value="612">612 - Personas Físicas con Actividades Empresariales</option>
                                        <option value="616">616 - Sin obligaciones fiscales</option>
                                        <option value="626">626 - Régimen Simplificado de Confianza</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Razón Social <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="txtRazonSocial" required>
                        </div>

                        <div class="form-group">
                            <label>Nombre Comercial</label>
                            <input type="text" class="form-control" id="txtNombreComercial">
                        </div>

                        <hr>
                        <h5>Domicilio Fiscal</h5>

                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label>Calle <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="txtCalle" required>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>No. Ext</label>
                                    <input type="text" class="form-control" id="txtNumeroExterior">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>No. Int</label>
                                    <input type="text" class="form-control" id="txtNumeroInterior">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Colonia <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="txtColonia" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Código Postal <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="txtCodigoPostal" maxlength="5" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Municipio <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="txtMunicipio" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Estado <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="txtEstado" required>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>País</label>
                            <input type="text" class="form-control" id="txtPais" value="México">
                        </div>

                        <hr>
                        <h5>Contacto</h5>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Teléfono</label>
                                    <input type="tel" class="form-control" id="txtTelefono">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" class="form-control" id="txtEmail">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Sitio Web</label>
                                    <input type="url" class="form-control" id="txtSitioWeb">
                                </div>
                            </div>
                        </div>

                        <div class="text-right">
                            <button type="button" class="btn btn-secondary" onclick="window.location.href='@Url.Action("Dashboard", "Contador")'">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary" id="btnGuardar">
                                <i class="fas fa-save"></i> Guardar Cambios
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow mb-3">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Información</h5>
                </div>
                <div class="card-body">
                    <p><strong>Importante:</strong></p>
                    <ul>
                        <li>El RFC debe ser válido y coincidir con el SAT</li>
                        <li>El régimen fiscal debe estar activo</li>
                        <li>El domicilio fiscal debe coincidir con el RFC</li>
                        <li>Estos datos se usan en todos los CFDI</li>
                    </ul>
                </div>
            </div>

            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Advertencia</h5>
                </div>
                <div class="card-body">
                    <p><strong>Antes de modificar:</strong></p>
                    <ul>
                        <li>Verifica que no haya timbrados pendientes</li>
                        <li>Los cambios afectan facturas futuras</li>
                        <li>No afecta CFDIs ya timbrados</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            cargarConfiguracion();

            $('#formEmpresa').submit(function (e) {
                e.preventDefault();
                guardarConfiguracion();
            });
        });

        function cargarConfiguracion() {
            $.get('/Contador/ObtenerConfiguracionEmpresa', function (response) {
                if (response.success && response.data) {
                    var data = response.data;
                    $('#txtRFC').val(data.RFC);
                    $('#txtRazonSocial').val(data.RazonSocial);
                    $('#txtNombreComercial').val(data.NombreComercial);
                    $('#cboRegimenFiscal').val(data.RegimenFiscal);
                    $('#txtCalle').val(data.Calle);
                    $('#txtNumeroExterior').val(data.NumeroExterior);
                    $('#txtNumeroInterior').val(data.NumeroInterior);
                    $('#txtColonia').val(data.Colonia);
                    $('#txtCodigoPostal').val(data.CodigoPostal);
                    $('#txtMunicipio').val(data.Municipio);
                    $('#txtEstado').val(data.Estado);
                    $('#txtPais').val(data.Pais);
                    $('#txtTelefono').val(data.Telefono);
                    $('#txtEmail').val(data.Email);
                    $('#txtSitioWeb').val(data.SitioWeb);
                }
            });
        }

        function guardarConfiguracion() {
            var request = {
                RFC: $('#txtRFC').val().trim().toUpperCase(),
                RazonSocial: $('#txtRazonSocial').val().trim(),
                NombreComercial: $('#txtNombreComercial').val().trim(),
                RegimenFiscal: $('#cboRegimenFiscal').val(),
                Calle: $('#txtCalle').val().trim(),
                NumeroExterior: $('#txtNumeroExterior').val().trim(),
                NumeroInterior: $('#txtNumeroInterior').val().trim(),
                Colonia: $('#txtColonia').val().trim(),
                CodigoPostal: $('#txtCodigoPostal').val().trim(),
                Municipio: $('#txtMunicipio').val().trim(),
                Estado: $('#txtEstado').val().trim(),
                Pais: $('#txtPais').val().trim(),
                Telefono: $('#txtTelefono').val().trim(),
                Email: $('#txtEmail').val().trim(),
                SitioWeb: $('#txtSitioWeb').val().trim()
            };

            $('#btnGuardar').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Guardando...');

            $.post('/Contador/ActualizarEmpresa', request, function (response) {
                if (response.success) {
                    toastr.success(response.mensaje);
                } else {
                    toastr.error(response.mensaje);
                }
            }).fail(function () {
                toastr.error('Error de conexión');
            }).always(function () {
                $('#btnGuardar').prop('disabled', false).html('<i class="fas fa-save"></i> Guardar Cambios');
            });
        }
    </script>
}
