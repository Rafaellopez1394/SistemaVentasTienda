@{
    ViewBag.Title = "Traspasos entre Sucursales";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-exchange-alt"></i> Traspasos entre Sucursales
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Botón Nuevo Traspaso -->
                    <div class="mb-3">
                        <a href="@Url.Action("Registrar", "Traspaso")" class="btn btn-success">
                            <i class="fas fa-plus"></i> Nuevo Traspaso
                        </a>
                    </div>

                    <!-- Filtros -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <label>Fecha Inicio</label>
                                    <input type="date" id="txtFechaInicio" class="form-control" />
                                </div>
                                <div class="col-md-3">
                                    <label>Fecha Fin</label>
                                    <input type="date" id="txtFechaFin" class="form-control" />
                                </div>
                                <div class="col-md-3">
                                    <label>Estatus</label>
                                    <select id="cboEstatus" class="form-control">
                                        <option value="">Todos</option>
                                        <option value="PENDIENTE">Pendiente</option>
                                        <option value="EN_TRANSITO">En Tránsito</option>
                                        <option value="RECIBIDO">Recibido</option>
                                        <option value="CANCELADO">Cancelado</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label>&nbsp;</label>
                                    <button id="btnFiltrar" class="btn btn-primary btn-block">
                                        <i class="fas fa-search"></i> Buscar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de Traspasos -->
                    <div class="table-responsive">
                        <table id="tablaTraspasos" class="table table-striped table-bordered table-hover" style="width:100%">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Folio</th>
                                    <th>Fecha</th>
                                    <th>Origen</th>
                                    <th>Destino</th>
                                    <th>Productos</th>
                                    <th>Cantidad</th>
                                    <th>Valor</th>
                                    <th>Estatus</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <link href="https://cdn.datatables.net/1.10.24/css/dataTables.bootstrap4.min.css" rel="stylesheet" />
    <script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/dataTables.bootstrap4.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

    <script>
        var tablaTraspasos;

        $(document).ready(function () {
            // Inicializar fechas (últimos 30 días)
            var fechaFin = new Date();
            var fechaInicio = new Date();
            fechaInicio.setDate(fechaFin.getDate() - 30);
            
            $('#txtFechaInicio').val(fechaInicio.toISOString().split('T')[0]);
            $('#txtFechaFin').val(fechaFin.toISOString().split('T')[0]);

            // Inicializar DataTable
            tablaTraspasos = $('#tablaTraspasos').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.10.24/i18n/Spanish.json'
                },
                columns: [
                    { data: 'FolioTraspaso' },
                    { data: 'FechaTraspaso' },
                    { data: 'SucursalOrigen' },
                    { data: 'SucursalDestino' },
                    { data: 'TotalProductos', className: 'text-center' },
                    { data: 'TotalCantidad', className: 'text-right' },
                    { data: 'ValorTotal', className: 'text-right' },
                    {
                        data: 'Estatus',
                        className: 'text-center',
                        render: function (data) {
                            var badge = '';
                            switch (data) {
                                case 'PENDIENTE':
                                    badge = '<span class="badge badge-warning">Pendiente</span>';
                                    break;
                                case 'EN_TRANSITO':
                                    badge = '<span class="badge badge-info">En Tránsito</span>';
                                    break;
                                case 'RECIBIDO':
                                    badge = '<span class="badge badge-success">Recibido</span>';
                                    break;
                                case 'CANCELADO':
                                    badge = '<span class="badge badge-danger">Cancelado</span>';
                                    break;
                            }
                            return badge;
                        }
                    },
                    {
                        data: null,
                        className: 'text-center',
                        render: function (data, type, row) {
                            return '<a href="/Traspaso/Detalle/' + row.TraspasoID + '" class="btn btn-sm btn-info" title="Ver Detalle">' +
                                '<i class="fas fa-eye"></i></a>';
                        }
                    }
                ]
            });

            // Cargar datos iniciales
            cargarTraspasos();

            // Evento del botón filtrar
            $('#btnFiltrar').click(function () {
                cargarTraspasos();
            });
        });

        function cargarTraspasos() {
            var fechaInicio = $('#txtFechaInicio').val();
            var fechaFin = $('#txtFechaFin').val();
            var estatus = $('#cboEstatus').val();

            $.ajax({
                url: '@Url.Action("ConsultarTraspasos", "Traspaso")',
                type: 'GET',
                data: {
                    fechaInicio: fechaInicio,
                    fechaFin: fechaFin,
                    estatus: estatus
                },
                success: function (response) {
                    if (response.success) {
                        tablaTraspasos.clear();
                        tablaTraspasos.rows.add(response.data);
                        tablaTraspasos.draw();
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function () {
                    alert('Error al cargar los traspasos');
                }
            });
        }
    </script>
}
