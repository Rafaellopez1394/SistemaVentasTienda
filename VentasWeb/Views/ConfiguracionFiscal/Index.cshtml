@{
    ViewBag.Title = "Configuración Fiscal y Certificados";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h2 class="page-header">
                <i class="fa fa-certificate"></i> Configuración Fiscal y Certificados Digitales
            </h2>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs" role="tablist">
        <li role="presentation" class="active">
            <a href="#datos-fiscales" aria-controls="datos-fiscales" role="tab" data-toggle="tab">
                <i class="fa fa-building"></i> Datos Fiscales
            </a>
        </li>
        <li role="presentation">
            <a href="#certificados" aria-controls="certificados" role="tab" data-toggle="tab">
                <i class="fa fa-key"></i> Certificados Digitales
            </a>
        </li>
        <li role="presentation">
            <a href="#api-config" aria-controls="api-config" role="tab" data-toggle="tab">
                <i class="fa fa-cog"></i> Configuración PAC
            </a>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" style="margin-top: 20px;">
        
        <!-- TAB 1: DATOS FISCALES -->
        <div role="tabpanel" class="tab-pane active" id="datos-fiscales">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title"><i class="fa fa-building"></i> Información del Emisor</h3>
                </div>
                <div class="panel-body">
                    <form id="formDatosFiscales">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="txtRFC">RFC del Emisor <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="txtRFC" placeholder="XAXX010101000" maxlength="13" style="text-transform: uppercase;">
                                    <small class="text-muted">RFC a 12 o 13 posiciones</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="txtNombreEmisor">Razón Social / Nombre <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="txtNombreEmisor" placeholder="NOMBRE O RAZON SOCIAL" style="text-transform: uppercase;">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="txtRegimenFiscal">Régimen Fiscal <span class="text-danger">*</span></label>
                                    <select class="form-control" id="txtRegimenFiscal">
                                        <option value="">Seleccione...</option>
                                        <option value="601">601 - General de Ley Personas Morales</option>
                                        <option value="603">603 - Personas Morales con Fines no Lucrativos</option>
                                        <option value="605">605 - Sueldos y Salarios e Ingresos Asimilados a Salarios</option>
                                        <option value="606">606 - Arrendamiento</option>
                                        <option value="607">607 - Régimen de Enajenación o Adquisición de Bienes</option>
                                        <option value="608">608 - Demás ingresos</option>
                                        <option value="610">610 - Residentes en el Extranjero sin Establecimiento Permanente en México</option>
                                        <option value="611">611 - Ingresos por Dividendos (socios y accionistas)</option>
                                        <option value="612">612 - Personas Físicas con Actividades Empresariales y Profesionales</option>
                                        <option value="614">614 - Ingresos por intereses</option>
                                        <option value="615">615 - Régimen de los ingresos por obtención de premios</option>
                                        <option value="616">616 - Sin obligaciones fiscales</option>
                                        <option value="620">620 - Sociedades Cooperativas de Producción que optan por diferir sus ingresos</option>
                                        <option value="621">621 - Incorporación Fiscal</option>
                                        <option value="622">622 - Actividades Agrícolas, Ganaderas, Silvícolas y Pesqueras</option>
                                        <option value="623">623 - Opcional para Grupos de Sociedades</option>
                                        <option value="624">624 - Coordinados</option>
                                        <option value="625">625 - Régimen de las Actividades Empresariales con ingresos a través de Plataformas Tecnológicas</option>
                                        <option value="626">626 - Régimen Simplificado de Confianza</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="txtCodigoPostal">Código Postal <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="txtCodigoPostal" placeholder="00000" maxlength="5">
                                    <small class="text-muted">Código postal del domicilio fiscal</small>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fa fa-save"></i> Guardar Datos Fiscales
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- TAB 2: CERTIFICADOS -->
        <div role="tabpanel" class="tab-pane" id="certificados">
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h3 class="panel-title"><i class="fa fa-upload"></i> Cargar Certificado Digital (CSD)</h3>
                </div>
                <div class="panel-body">
                    <div class="alert alert-info">
                        <i class="fa fa-info-circle"></i> <strong>Instrucciones:</strong>
                        <ul>
                            <li>Necesitas los archivos <strong>.cer</strong> y <strong>.key</strong> otorgados por el SAT</li>
                            <li>Debes conocer la <strong>contraseña</strong> de la llave privada (.key)</li>
                            <li>Los certificados tienen vigencia limitada, verifica que estén vigentes</li>
                        </ul>
                    </div>

                    <form id="formCertificado" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="txtNombreCertificado">Nombre del Certificado</label>
                                    <input type="text" class="form-control" id="txtNombreCertificado" placeholder="Ej: Certificado Producción 2026">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="txtRFCCert">RFC <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="txtRFCCert" placeholder="RFC del certificado" maxlength="13" style="text-transform: uppercase;">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="txtRazonSocialCert">Razón Social</label>
                                    <input type="text" class="form-control" id="txtRazonSocialCert" placeholder="Razón social" style="text-transform: uppercase;">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="fileCER">Archivo CER <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-addon"><i class="fa fa-file"></i></span>
                                        <input type="file" class="form-control" id="fileCER" accept=".cer">
                                    </div>
                                    <small class="text-muted">Certificado (.cer)</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="fileKEY">Archivo KEY <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-addon"><i class="fa fa-key"></i></span>
                                        <input type="file" class="form-control" id="fileKEY" accept=".key">
                                    </div>
                                    <small class="text-muted">Llave privada (.key)</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="txtPassword">Contraseña KEY <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-addon"><i class="fa fa-lock"></i></span>
                                        <input type="password" class="form-control" id="txtPassword" placeholder="Contraseña del archivo KEY">
                                    </div>
                                    <small class="text-muted">Contraseña de la llave privada</small>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fa fa-upload"></i> Cargar Certificado
                                </button>
                            </div>
                        </div>
                    </form>

                    <hr>

                    <!-- Lista de certificados -->
                    <h4><i class="fa fa-list"></i> Certificados Cargados</h4>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="tablaCertificados">
                            <thead>
                                <tr class="bg-primary">
                                    <th>Nombre</th>
                                    <th>RFC</th>
                                    <th>Razón Social</th>
                                    <th>Vigencia</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyCertificados">
                                <tr>
                                    <td colspan="6" class="text-center text-muted">
                                        <i class="fa fa-info-circle"></i> No hay certificados cargados
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 3: CONFIGURACIÓN PAC -->
        <div role="tabpanel" class="tab-pane" id="api-config">
            <div class="panel panel-warning">
                <div class="panel-heading">
                    <h3 class="panel-title"><i class="fa fa-cog"></i> Configuración del PAC (Proveedor Autorizado de Certificación)</h3>
                </div>
                <div class="panel-body">
                    <div class="alert alert-warning">
                        <i class="fa fa-exclamation-triangle"></i> <strong>Importante:</strong> Necesitas contratar un PAC (FiscalAPI, Facturama, etc.) para generar facturas electrónicas.
                    </div>

                    <form id="formPAC">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="txtApiKey">API Key <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="txtApiKey" placeholder="Tu API Key del PAC">
                                    <small class="text-muted">Proporcionada por tu proveedor PAC</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="txtTenant">Tenant / ID Usuario</label>
                                    <input type="text" class="form-control" id="txtTenant" placeholder="Tu tenant o ID de usuario">
                                    <small class="text-muted">Opcional, según tu PAC</small>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="txtAmbiente">Ambiente <span class="text-danger">*</span></label>
                                    <select class="form-control" id="txtAmbiente">
                                        <option value="Pruebas">Pruebas / Sandbox</option>
                                        <option value="Produccion">Producción</option>
                                    </select>
                                    <small class="text-muted">Usa "Pruebas" mientras configuras el sistema</small>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <button type="submit" class="btn btn-warning btn-lg">
                                    <i class="fa fa-save"></i> Guardar Configuración PAC
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Estado de la configuración -->
            <div class="panel panel-success">
                <div class="panel-heading">
                    <h3 class="panel-title"><i class="fa fa-check-circle"></i> Estado de Configuración</h3>
                </div>
                <div class="panel-body" id="estadoConfiguracion">
                    <p class="text-muted"><i class="fa fa-spinner fa-spin"></i> Cargando estado...</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
<script>
    $(document).ready(function () {
        cargarConfiguracion();
        cargarCertificados();

        // Guardar datos fiscales
        $('#formDatosFiscales').submit(function (e) {
            e.preventDefault();
            guardarDatosFiscales();
        });

        // Cargar certificado
        $('#formCertificado').submit(function (e) {
            e.preventDefault();
            cargarCertificado();
        });

        // Guardar configuración PAC
        $('#formPAC').submit(function (e) {
            e.preventDefault();
            guardarConfiguracionPAC();
        });
    });

    function cargarConfiguracion() {
        $.ajax({
            url: '@Url.Action("ObtenerConfiguracion", "ConfiguracionFiscal")',
            type: 'GET',
            success: function (response) {
                if (response.success) {
                    $('#txtRFC').val(response.data.rfcEmisor);
                    $('#txtNombreEmisor').val(response.data.nombreEmisor);
                    $('#txtRegimenFiscal').val(response.data.regimenFiscal);
                    $('#txtCodigoPostal').val(response.data.codigoPostal);
                    $('#txtApiKey').val(response.data.apiKey);
                    $('#txtTenant').val(response.data.tenant);
                    $('#txtAmbiente').val(response.data.ambiente);
                    
                    actualizarEstadoConfiguracion(response.data);
                }
            }
        });
    }

    function cargarCertificados() {
        $.ajax({
            url: '@Url.Action("ObtenerCertificados", "ConfiguracionFiscal")',
            type: 'GET',
            success: function (response) {
                if (response.success) {
                    mostrarCertificados(response.data);
                }
            }
        });
    }

    function guardarDatosFiscales() {
        var datos = {
            rfcEmisor: $('#txtRFC').val().trim().toUpperCase(),
            nombreEmisor: $('#txtNombreEmisor').val().trim().toUpperCase(),
            regimenFiscal: $('#txtRegimenFiscal').val(),
            codigoPostal: $('#txtCodigoPostal').val().trim(),
            apiKey: $('#txtApiKey').val().trim(),
            tenant: $('#txtTenant').val().trim(),
            ambiente: $('#txtAmbiente').val()
        };

        if (!datos.rfcEmisor || !datos.nombreEmisor || !datos.regimenFiscal || !datos.codigoPostal) {
            if (typeof swal === 'function') {
                swal('Error', 'Complete todos los campos obligatorios', 'error');
            } else {
                alert('Error: Complete todos los campos obligatorios');
            }
            return;
        }

        $.ajax({
            url: '@Url.Action("GuardarConfiguracion", "ConfiguracionFiscal")',
            type: 'POST',
            data: datos,
            success: function (response) {
                if (response.success) {
                    if (typeof swal === 'function') {
                        swal('Éxito', response.message, 'success');
                    } else {
                        alert('Éxito: ' + response.message);
                    }
                    cargarConfiguracion();
                } else {
                    if (typeof swal === 'function') {
                        swal('Error', response.message, 'error');
                    } else {
                        alert('Error: ' + response.message);
                    }
                }
            },
            error: function() {
                if (typeof swal === 'function') {
                    swal('Error', 'No se pudo guardar la configuración', 'error');
                } else {
                    alert('Error: No se pudo guardar la configuración');
                }
            }
        });
    }

    function cargarCertificado() {
        var formData = new FormData();
        
        var fileCER = $('#fileCER')[0].files[0];
        var fileKEY = $('#fileKEY')[0].files[0];
        var password = $('#txtPassword').val();
        
        if (!fileCER || !fileKEY || !password) {
            swal('Error', 'Debe seleccionar ambos archivos y proporcionar la contraseña', 'error');
            return;
        }

        formData.append('archivoCER', fileCER);
        formData.append('archivoKEY', fileKEY);
        formData.append('password', password);
        formData.append('nombreCertificado', $('#txtNombreCertificado').val() || 'Certificado ' + new Date().toLocaleDateString());
        formData.append('rfc', $('#txtRFCCert').val().trim().toUpperCase());
        formData.append('razonSocial', $('#txtRazonSocialCert').val().trim().toUpperCase());

        $.ajax({
            url: '@Url.Action("CargarCertificado", "ConfiguracionFiscal")',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                if (response.success) {
                    swal('Éxito', response.message, 'success');
                    $('#formCertificado')[0].reset();
                    cargarCertificados();
                    cargarConfiguracion();
                } else {
                    swal('Error', response.message, 'error');
                }
            },
            error: function () {
                swal('Error', 'No se pudo cargar el certificado', 'error');
            }
        });
    }

    function guardarConfiguracionPAC() {
        guardarDatosFiscales();
    }

    function mostrarCertificados(certificados) {
        var tbody = $('#tbodyCertificados');
        tbody.empty();

        if (certificados.length === 0) {
            tbody.append('<tr><td colspan="6" class="text-center text-muted"><i class="fa fa-info-circle"></i> No hay certificados cargados</td></tr>');
            return;
        }

        certificados.forEach(function (cert) {
            var badge = cert.predeterminado ? '<span class="badge badge-success">Predeterminado</span>' : '';
            var estado = cert.activo ? '<span class="label label-success">Activo</span>' : '<span class="label label-default">Inactivo</span>';
            
            var row = '<tr>' +
                '<td>' + cert.nombre + ' ' + badge + '</td>' +
                '<td>' + cert.rfc + '</td>' +
                '<td>' + cert.razonSocial + '</td>' +
                '<td>' + (cert.fechaInicio || 'N/A') + ' - ' + (cert.fechaFin || 'N/A') + '</td>' +
                '<td>' + estado + '</td>' +
                '<td>' +
                '<button class="btn btn-danger btn-sm" onclick="eliminarCertificado(' + cert.certificadoId + ')">' +
                '<i class="fa fa-trash"></i> Eliminar' +
                '</button>' +
                '</td>' +
                '</tr>';
            tbody.append(row);
        });
    }

    function eliminarCertificado(id) {
        swal({
            title: '¿Eliminar certificado?',
            text: 'Esta acción no se puede deshacer',
            type: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then(function () {
            $.ajax({
                url: '@Url.Action("EliminarCertificado", "ConfiguracionFiscal")',
                type: 'POST',
                data: { certificadoId: id },
                success: function (response) {
                    if (response.success) {
                        swal('Eliminado', response.message, 'success');
                        cargarCertificados();
                    } else {
                        swal('Error', response.message, 'error');
                    }
                }
            });
        });
    }

    function actualizarEstadoConfiguracion(config) {
        var html = '<ul class="list-group">';
        html += '<li class="list-group-item">';
        html += '<strong>RFC Emisor:</strong> ' + (config.rfcEmisor || '<span class="text-danger">No configurado</span>');
        html += config.rfcEmisor ? ' <i class="fa fa-check text-success"></i>' : ' <i class="fa fa-times text-danger"></i>';
        html += '</li>';
        
        html += '<li class="list-group-item">';
        html += '<strong>Razón Social:</strong> ' + (config.nombreEmisor || '<span class="text-danger">No configurado</span>');
        html += config.nombreEmisor ? ' <i class="fa fa-check text-success"></i>' : ' <i class="fa fa-times text-danger"></i>';
        html += '</li>';
        
        html += '<li class="list-group-item">';
        html += '<strong>Certificado Digital:</strong> ' + (config.tieneCertificado ? '<span class="text-success">Cargado</span> <i class="fa fa-check text-success"></i>' : '<span class="text-danger">No cargado</span> <i class="fa fa-times text-danger"></i>');
        html += '</li>';
        
        html += '<li class="list-group-item">';
        html += '<strong>API Key:</strong> ' + (config.apiKey ? '<span class="text-success">Configurado</span> <i class="fa fa-check text-success"></i>' : '<span class="text-danger">No configurado</span> <i class="fa fa-times text-danger"></i>');
        html += '</li>';
        
        html += '<li class="list-group-item">';
        html += '<strong>Ambiente:</strong> <span class="label ' + (config.ambiente === 'Produccion' ? 'label-danger' : 'label-info') + '">' + config.ambiente + '</span>';
        html += '</li>';
        
        html += '</ul>';
        
        var todoListo = config.rfcEmisor && config.nombreEmisor && config.tieneCertificado && config.apiKey;
        if (todoListo) {
            html += '<div class="alert alert-success"><i class="fa fa-check-circle"></i> <strong>¡Sistema listo para facturar!</strong></div>';
        } else {
            html += '<div class="alert alert-warning"><i class="fa fa-exclamation-triangle"></i> <strong>Complete la configuración para poder facturar</strong></div>';
        }
        
        $('#estadoConfiguracion').html(html);
    }
</script>
}
