@{
    ViewBag.Title = "Recuperación de Crédito";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h4><i class="fa fa-credit-card"></i> Concentrado de Recuperación de Crédito</h4>
                    <p class="mb-0">Seguimiento diario: Créditos otorgados vs Cobros realizados</p>
                </div>
                <div class="card-body">
                    <!-- Filtros -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <label>Fecha Inicio:</label>
                            <input type="date" id="txtFechaInicio" class="form-control" value="@DateTime.Now.AddDays(-30).ToString("yyyy-MM-dd")" />
                        </div>
                        <div class="col-md-3">
                            <label>Fecha Fin:</label>
                            <input type="date" id="txtFechaFin" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                        </div>
                        <div class="col-md-4">
                            <label>&nbsp;</label><br />
                            <button type="button" class="btn btn-info" onclick="cargarRecuperacion()">
                                <i class="fa fa-search"></i> Generar Reporte
                            </button>
                        </div>
                    </div>

                    <!-- Resumen -->
                    <div class="row mb-4" id="divResumen" style="display:none;">
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h5>Créditos Otorgados</h5>
                                    <h3 id="lblTotalCreditos">$0.00</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h5>Cobros Realizados</h5>
                                    <h3 id="lblTotalCobros">$0.00</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h5>% Recuperación</h5>
                                    <h3 id="lblPorcentajeRecuperacion">0%</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-danger text-white">
                                <div class="card-body text-center">
                                    <h5>Cartera Vencida</h5>
                                    <h3 id="lblCarteraVencida">$0.00</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla -->
                    <div class="table-responsive">
                        <table id="tbRecuperacion" class="table table-striped table-bordered table-hover" style="width:100%">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Fecha</th>
                                    <th>Clientes</th>
                                    <th>Créditos Otorgados</th>
                                    <th>Cobros Realizados</th>
                                    <th>Saldo Inicial</th>
                                    <th>Saldo Final</th>
                                    <th>% Recuperación</th>
                                    <th>Cartera Vigente</th>
                                    <th>Cartera Vencida</th>
                                    <th>% Vencido</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                            <tfoot>
                                <tr class="table-dark font-weight-bold">
                                    <td>TOTAL</td>
                                    <td id="sumClientes">0</td>
                                    <td id="sumCreditos">$0.00</td>
                                    <td id="sumCobros">$0.00</td>
                                    <td>-</td>
                                    <td id="saldoFinalTotal">$0.00</td>
                                    <td id="recuperacionPromedio">0%</td>
                                    <td id="vigenteFinal">$0.00</td>
                                    <td id="vencidoFinal">$0.00</td>
                                    <td id="porcentajeVencidoFinal">0%</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Gráfica -->
                    <div class="row mt-4" id="divGrafica" style="display:none;">
                        <div class="col-md-12">
                            <canvas id="chartRecuperacion" height="80"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
        var tabla;
        var chartRecuperacion;

        $(document).ready(function () {
            tabla = $('#tbRecuperacion').DataTable({
                "language": {
                    "url": "https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-MX.json"
                },
                "columns": [
                    { 
                        "data": "Fecha", 
                        "render": function (data) { 
                            // Convertir /Date(timestamp)/ a fecha legible
                            var fecha = new Date(parseInt(data.substr(6)));
                            return fecha.toLocaleDateString('es-MX', { year: 'numeric', month: '2-digit', day: '2-digit' }); 
                        } 
                    },
                    { "data": "TotalClientesCredito" },
                    { "data": "CreditosOtorgados", "render": function (data) { return "$" + parseFloat(data).toLocaleString('es-MX', { minimumFractionDigits: 2 }); } },
                    { "data": "CobrosRealizados", "render": function (data) { return "$" + parseFloat(data).toLocaleString('es-MX', { minimumFractionDigits: 2 }); } },
                    { "data": "SaldoInicial", "render": function (data) { return "$" + parseFloat(data).toLocaleString('es-MX', { minimumFractionDigits: 2 }); } },
                    { "data": "SaldoFinal", "render": function (data) { return "$" + parseFloat(data).toLocaleString('es-MX', { minimumFractionDigits: 2 }); } },
                    { 
                        "data": "PorcentajeRecuperacion", 
                        "render": function (data) { 
                            var color = data >= 80 ? 'green' : (data >= 50 ? 'orange' : 'red');
                            return "<span style='color:" + color + ";font-weight:bold;'>" + parseFloat(data).toFixed(2) + "%</span>"; 
                        } 
                    },
                    { "data": "CarteraVigente", "render": function (data) { return "$" + parseFloat(data).toLocaleString('es-MX', { minimumFractionDigits: 2 }); } },
                    { "data": "CarteraVencida", "render": function (data) { return "$" + parseFloat(data).toLocaleString('es-MX', { minimumFractionDigits: 2 }); } },
                    { 
                        "data": "PorcentajeVencido", 
                        "render": function (data) { 
                            var color = data <= 10 ? 'green' : (data <= 25 ? 'orange' : 'red');
                            return "<span style='color:" + color + ";font-weight:bold;'>" + parseFloat(data).toFixed(2) + "%</span>"; 
                        } 
                    }
                ],
                "order": [[0, "desc"]],
                "pageLength": 31
            });
        });

        function cargarRecuperacion() {
            var fechaInicio = $('#txtFechaInicio').val();
            var fechaFin = $('#txtFechaFin').val();

            if (!fechaInicio || !fechaFin) {
                alert('Por favor seleccione ambas fechas');
                return;
            }

            $.ajax({
                url: '@Url.Action("ObtenerRecuperacionCredito", "ReporteAvanzado")',
                type: 'GET',
                data: { fechaInicio: fechaInicio, fechaFin: fechaFin },
                beforeSend: function () {
                    $.LoadingOverlay("show");
                },
                success: function (response) {
                    $.LoadingOverlay("hide");
                    if (response.success) {
                        tabla.clear();
                        tabla.rows.add(response.data);
                        tabla.draw();

                        // Calcular totales
                        var totalCreditos = 0;
                        var totalCobros = 0;
                        var saldoFinal = 0;
                        var vigenteFinal = 0;
                        var vencidoFinal = 0;

                        response.data.forEach(function (item) {
                            totalCreditos += item.CreditosOtorgados;
                            totalCobros += item.CobrosRealizados;
                        });

                        if (response.data.length > 0) {
                            var ultimoDia = response.data[response.data.length - 1];
                            saldoFinal = ultimoDia.SaldoFinal;
                            vigenteFinal = ultimoDia.CarteraVigente;
                            vencidoFinal = ultimoDia.CarteraVencida;
                        }

                        var porcentajeRecuperacion = totalCreditos > 0 ? (totalCobros / totalCreditos) * 100 : 0;
                        var porcentajeVencido = saldoFinal > 0 ? (vencidoFinal / saldoFinal) * 100 : 0;

                        // Actualizar cards de resumen
                        $('#lblTotalCreditos').text('$' + totalCreditos.toLocaleString('es-MX', { minimumFractionDigits: 2 }));
                        $('#lblTotalCobros').text('$' + totalCobros.toLocaleString('es-MX', { minimumFractionDigits: 2 }));
                        $('#lblPorcentajeRecuperacion').text(porcentajeRecuperacion.toFixed(2) + '%');
                        $('#lblCarteraVencida').text('$' + vencidoFinal.toLocaleString('es-MX', { minimumFractionDigits: 2 }));

                        // Actualizar footer
                        $('#sumCreditos').text('$' + totalCreditos.toLocaleString('es-MX', { minimumFractionDigits: 2 }));
                        $('#sumCobros').text('$' + totalCobros.toLocaleString('es-MX', { minimumFractionDigits: 2 }));
                        $('#saldoFinalTotal').text('$' + saldoFinal.toLocaleString('es-MX', { minimumFractionDigits: 2 }));
                        $('#recuperacionPromedio').text(porcentajeRecuperacion.toFixed(2) + '%');
                        $('#vigenteFinal').text('$' + vigenteFinal.toLocaleString('es-MX', { minimumFractionDigits: 2 }));
                        $('#vencidoFinal').text('$' + vencidoFinal.toLocaleString('es-MX', { minimumFractionDigits: 2 }));
                        $('#porcentajeVencidoFinal').text(porcentajeVencido.toFixed(2) + '%');

                        $('#divResumen').show();

                        // Crear gráfica
                        crearGrafica(response.data);
                    } else {
                        alert('Error: ' + response.mensaje);
                    }
                },
                error: function (xhr) {
                    $.LoadingOverlay("hide");
                    alert('Error al cargar el reporte');
                }
            });
        }

        function crearGrafica(datos) {
            var labels = datos.map(function (item) { 
                // Convertir fecha correctamente (viene como /Date(timestamp)/ desde JSON)
                var fecha = new Date(parseInt(item.Fecha.substr(6)));
                return fecha.toLocaleDateString('es-MX', { day: '2-digit', month: '2-digit' }); 
            });
            var creditos = datos.map(function (item) { return item.CreditosOtorgados; });
            var cobros = datos.map(function (item) { return item.CobrosRealizados; });
            var saldo = datos.map(function (item) { return item.SaldoFinal; });

            if (chartRecuperacion) {
                chartRecuperacion.destroy();
            }

            var ctx = document.getElementById('chartRecuperacion').getContext('2d');
            chartRecuperacion = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Créditos Otorgados',
                            data: creditos,
                            borderColor: 'rgb(255, 159, 64)',
                            backgroundColor: 'rgba(255, 159, 64, 0.2)',
                            tension: 0.1
                        },
                        {
                            label: 'Cobros Realizados',
                            data: cobros,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1
                        },
                        {
                            label: 'Saldo Acumulado',
                            data: saldo,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Evolución Diaria de Crédito y Cobranza' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return '$' + value.toLocaleString('es-MX');
                                }
                            }
                        }
                    }
                }
            });

            $('#divGrafica').show();
        }
    </script>
}
