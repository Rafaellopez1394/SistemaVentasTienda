@{
    ViewBag.Title = "Reporte de Utilidad por Producto";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4><i class="fa fa-chart-line"></i> Reporte de Utilidad por Producto</h4>
                    <p class="mb-0">Análisis de rentabilidad: costos vs ventas vs utilidad</p>
                </div>
                <div class="card-body">
                    <!-- Filtros -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <label>Fecha Inicio:</label>
                            <input type="date" id="txtFechaInicio" class="form-control" value="@DateTime.Now.AddMonths(-1).ToString("yyyy-MM-dd")" />
                        </div>
                        <div class="col-md-3">
                            <label>Fecha Fin:</label>
                            <input type="date" id="txtFechaFin" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                        </div>
                        <div class="col-md-4">
                            <label>&nbsp;</label><br />
                            <button type="button" class="btn btn-success" onclick="cargarReporte()">
                                <i class="fa fa-search"></i> Generar Reporte
                            </button>
                            <button type="button" class="btn btn-info" onclick="exportarExcel()">
                                <i class="fa fa-file-excel"></i> Exportar Excel
                            </button>
                        </div>
                    </div>

                    <!-- Resumen -->
                    <div class="row mb-4" id="divResumen" style="display:none;">
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h5>Utilidad Total</h5>
                                    <h3 id="lblUtilidadTotal">$0.00</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h5>Margen Promedio</h5>
                                    <h3 id="lblMargenPromedio">0%</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h5>Productos Analizados</h5>
                                    <h3 id="lblTotalProductos">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-danger text-white">
                                <div class="card-body text-center">
                                    <h5>Con Pérdidas</h5>
                                    <h3 id="lblConPerdidas">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla -->
                    <div class="table-responsive">
                        <table id="tbReporte" class="table table-striped table-bordered table-hover" style="width:100%">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Código</th>
                                    <th>Producto</th>
                                    <th>Categoría</th>
                                    <th>Cant Vendida</th>
                                    <th>Venta Total</th>
                                    <th>Costo Vendido</th>
                                    <th>Utilidad</th>
                                    <th>Margen %</th>
                                    <th>Rentabilidad</th>
                                    <th>Recomendación</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var tabla;

        $(document).ready(function () {
            // Inicializar DataTable
            tabla = $('#tbReporte').DataTable({
                "language": {
                    "url": "https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-MX.json"
                },
                "columns": [
                    { "data": "CodigoInterno" },
                    { "data": "NombreProducto" },
                    { "data": "Categoria" },
                    { "data": "CantidadVendida", "render": function (data) { return parseFloat(data).toFixed(2); } },
                    { "data": "ImporteTotalVentas", "render": function (data) { return "$" + parseFloat(data).toLocaleString('es-MX', { minimumFractionDigits: 2 }); } },
                    { "data": "CostoVendido", "render": function (data) { return "$" + parseFloat(data).toLocaleString('es-MX', { minimumFractionDigits: 2 }); } },
                    { 
                        "data": "UtilidadBruta", 
                        "render": function (data) { 
                            var color = data >= 0 ? 'green' : 'red';
                            return "<span style='color:" + color + ";font-weight:bold;'>$" + parseFloat(data).toLocaleString('es-MX', { minimumFractionDigits: 2 }) + "</span>"; 
                        } 
                    },
                    { 
                        "data": "MargenUtilidadPorcentaje", 
                        "render": function (data) { 
                            var color = data >= 30 ? 'green' : (data >= 15 ? 'orange' : 'red');
                            return "<span style='color:" + color + ";font-weight:bold;'>" + parseFloat(data).toFixed(2) + "%</span>"; 
                        } 
                    },
                    { 
                        "data": "Rentabilidad",
                        "render": function (data) {
                            var badge = '';
                            if (data == 'ALTA') badge = 'badge-success';
                            else if (data == 'MEDIA') badge = 'badge-warning';
                            else if (data == 'BAJA') badge = 'badge-secondary';
                            else badge = 'badge-danger';
                            return "<span class='badge " + badge + "'>" + data + "</span>";
                        }
                    },
                    { "data": "Recomendacion" }
                ],
                "order": [[6, "desc"]], // Ordenar por utilidad descendente
                "pageLength": 25
            });
        });

        function cargarReporte() {
            var fechaInicio = $('#txtFechaInicio').val();
            var fechaFin = $('#txtFechaFin').val();

            if (!fechaInicio || !fechaFin) {
                alert('Por favor seleccione ambas fechas');
                return;
            }

            $.ajax({
                url: '@Url.Action("ObtenerUtilidadProductos", "ReporteAvanzado")',
                type: 'GET',
                data: { fechaInicio: fechaInicio, fechaFin: fechaFin },
                beforeSend: function () {
                    $.LoadingOverlay("show");
                },
                success: function (response) {
                    $.LoadingOverlay("hide");
                    if (response.success) {
                        // Actualizar tabla
                        tabla.clear();
                        tabla.rows.add(response.data);
                        tabla.draw();

                        // Calcular resumen
                        var utilidadTotal = 0;
                        var margenTotal = 0;
                        var conPerdidas = 0;
                        
                        response.data.forEach(function (item) {
                            utilidadTotal += item.UtilidadBruta;
                            margenTotal += item.MargenUtilidadPorcentaje;
                            if (item.UtilidadBruta < 0) conPerdidas++;
                        });

                        var margenPromedio = response.data.length > 0 ? margenTotal / response.data.length : 0;

                        $('#lblUtilidadTotal').text('$' + utilidadTotal.toLocaleString('es-MX', { minimumFractionDigits: 2 }));
                        $('#lblMargenPromedio').text(margenPromedio.toFixed(2) + '%');
                        $('#lblTotalProductos').text(response.data.length);
                        $('#lblConPerdidas').text(conPerdidas);

                        $('#divResumen').show();
                    } else {
                        alert('Error: ' + response.mensaje);
                    }
                },
                error: function (xhr) {
                    $.LoadingOverlay("hide");
                    alert('Error al cargar el reporte');
                }
            });
        }

        function exportarExcel() {
            var fechaInicio = $('#txtFechaInicio').val();
            var fechaFin = $('#txtFechaFin').val();

            if (!fechaInicio || !fechaFin) {
                alert('Por favor seleccione ambas fechas');
                return;
            }

            window.location.href = '@Url.Action("ExportarUtilidadProductos", "ReporteAvanzado")?fechaInicio=' + fechaInicio + '&fechaFin=' + fechaFin;
        }
    </script>
}
